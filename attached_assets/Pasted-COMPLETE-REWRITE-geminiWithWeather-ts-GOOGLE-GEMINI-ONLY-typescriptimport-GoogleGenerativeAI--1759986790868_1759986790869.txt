COMPLETE REWRITE - geminiWithWeather.ts (GOOGLE GEMINI ONLY)
typescriptimport { GoogleGenerativeAI } from '@google/generative-ai';
import dotenv from 'dotenv';
import { SafetyIntelligenceService } from './safetyIntelligence.js';

dotenv.config();

const gemini = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
const safetyIntelligence = new SafetyIntelligenceService();

export class GeminiWithWeatherService {
  private model;

  constructor() {
    this.model = gemini.getGenerativeModel({
      model: 'gemini-2.5-flash',
    });
  }

  /**
   * Main analysis function - receives checklist AND weather separately
   */
  async analyzeChecklistWithWeather(
    checklistData: any,
    weatherData: any  // ← NOW REQUIRED AS SEPARATE PARAM
  ): Promise<string> {
    try {
      // Build the massive prompt with REAL OSHA data + weather
      const prompt = await this.buildChecklistAnalysisPrompt(
        checklistData,
        weatherData  // ← Pass weather separately
      );

      // Send to Gemini 2.5-flash at TEMPERATURE 1.0
      const result = await this.model.generateContent({
        contents: [{ role: 'user', parts: [{ text: prompt }] }],
        generationConfig: {
          temperature: 1.0,
          maxOutputTokens: 6000,
        },
      });

      return result.response.text();
    } catch (error) {
      console.error('Gemini predictive analysis error:', error);
      return `Predictive safety analysis failed: ${error}`;
    }
  }

  /**
   * Build comprehensive prompt with ALL data injected
   */
  private async buildChecklistAnalysisPrompt(
    checklistData: any,
    weatherData: any  // ← NOW ACCEPTS WEATHER AS PARAMETER
  ): Promise<string> {
    
    // Step 1: Query REAL OSHA data from Supabase
    let oshaDataSection = '';
    try {
      const constructionProfile = await safetyIntelligence.getRiskProfile('23');
      const industryBenchmarks = await safetyIntelligence.getIndustryBenchmark('23');
      
      oshaDataSection = `
**CONSTRUCTION INDUSTRY PROFILE (NAICS 23):**
- Industry Name: ${constructionProfile?.industry_name || 'Construction'}
- Injury Rate: ${constructionProfile?.injury_rate || 'N/A'} per 100 FTE (REAL BLS 2023 DATA)
- 2023 Fatalities: ${constructionProfile?.total_cases || 'N/A'} (REAL GOVERNMENT DATA)
- Risk Score: ${constructionProfile?.risk_score || 'N/A'}/100
- Risk Category: ${constructionProfile?.risk_category || 'N/A'}

**INDUSTRY BENCHMARKS (${industryBenchmarks?.length || 0} sub-categories):**
${industryBenchmarks ? JSON.stringify(industryBenchmarks, null, 2) : 'No benchmark data available'}

**THIS IS REAL DATA FROM YOUR SUPABASE OSHA TABLES - NOT ESTIMATES!**
Use this REAL statistical data to weight your risk predictions.
Compare this job site's conditions to these actual industry injury rates.
`;
    } catch (error) {
      console.error('Failed to fetch OSHA data:', error);
      oshaDataSection = '⚠️ OSHA DATA UNAVAILABLE - Proceeding with reduced statistical confidence';
    }

    // Step 2: Format weather data
    const weatherSection = weatherData 
      ? JSON.stringify(weatherData, null, 2)
      : '⚠️ NO WEATHER DATA - HIGH RISK';

    // Step 3: Extract checklist metadata
    const now = new Date();
    const siteLocation = checklistData.location || 
                        checklistData.site || 
                        checklistData.siteLocation || 
                        'Location not specified';
    const workType = checklistData.workType || 
                    checklistData.template || 
                    checklistData.templateId || 
                    'Work type not specified';
    const workHeight = checklistData.height || 
                      checklistData.workHeight || 
                      'Height not specified';

    // Step 4: Build the complete prompt with ALL placeholders replaced
    const prompt = `You are a Senior Safety Analyst specializing in incident prediction and prevention for construction environments.
═══════════════════════════════════════════
ANALYSIS CONTEXT - ${now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
═══════════════════════════════════════════
SITE: ${siteLocation}
WORK TYPE: ${workType}
WORK HEIGHT: ${workHeight} feet
TIME: ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}

CURRENT CONDITIONS:
${weatherSection}

CHECKLIST DATA:
${JSON.stringify(checklistData, null, 2)}

═══════════════════════════════════════════
REAL OSHA DATA FROM SUPABASE (BLS 2023)
═══════════════════════════════════════════
${oshaDataSection}

═══════════════════════════════════════════
PRE-ANALYSIS DATA VALIDATION
═══════════════════════════════════════════
CRITICAL DATA CHECK:
□ Weather data: ${weatherData ? 'PRESENT' : 'MISSING'}
□ Equipment specifications: ${checklistData.equipment ? 'PRESENT' : 'MISSING'}
□ Worker certifications: ${checklistData.certifications ? 'PRESENT' : 'MISSING'}
□ Emergency response plan: ${checklistData.emergencyPlan || checklistData.emergency_response ? 'PRESENT' : 'MISSING'}
□ OSHA statistical data: ${oshaDataSection.includes('N/A') ? 'PARTIAL' : 'PRESENT'}

IF any CRITICAL data is MISSING:
- EXECUTIVE DECISION defaults to NO-GO or GO WITH CONDITIONS
- Analysis proceeds with REDUCED CONFIDENCE
- Missing data items listed as IMMEDIATE ACTIONS
- State "INSUFFICIENT DATA FOR HIGH-CONFIDENCE PREDICTION" in affected sections

PERFORM THIS CHECK FIRST - Before any incident prediction.

═══════════════════════════════════════════
YOUR PRIMARY MISSION
═══════════════════════════════════════════
PREDICT THE INCIDENT THAT WILL HAPPEN TODAY IF NOTHING CHANGES.

Not "could happen" or "might happen" - based on:
1. Current site conditions
2. Statistical likelihood (OSHA data above)
3. Human performance factors
4. Systemic failures evident in the checklist

Tell me SPECIFICALLY:
- WHAT incident will occur
- EXACTLY HOW it will unfold (step-by-step causal chain)
- WHAT workers will observe 10-30 minutes before
- WHAT intervention breaks the chain

═══════════════════════════════════════════
MANDATORY STOP-WORK CONDITIONS (Check First)
═══════════════════════════════════════════
Evaluate these conditions BEFORE proceeding with incident forecasts.
IF any condition exists, EXECUTIVE DECISION = NO-GO

AUTOMATIC NO-GO TRIGGERS:
□ Emergency response plan missing or inadequate for HIGH-RISK work
□ Weather exceeds ANY equipment manufacturer limit (if limits known)
□ Required certifications unverified (crane operator, competent person, swing stage)
□ Anchor points not certified for fall protection system loads
□ Wind speed within 20% of any known equipment limit + no weather monitoring plan

IF NO-GO TRIGGERED:
1. State which specific condition(s) triggered stop-work
2. List specific actions required to clear NO-GO status
3. Provide realistic timeline to implement (hours/days, not "immediately")
4. Identify who has authority to clear the stop-work

IF NO TRIGGERS EXIST: Proceed with full analysis and incident forecasting.

═══════════════════════════════════════════
REQUIRED OUTPUT FORMAT
═══════════════════════════════════════════
**EXECUTIVE DECISION: [GO / GO WITH CONDITIONS / NO-GO]**

**PRIMARY THREAT TODAY:**
[One sentence: the specific incident most likely to occur]

---

**INCIDENT FORECAST #1: [Specific Incident Name]**

**Statistical Context:**
- OSHA incident rate for this work type: [X per 100 FTE from Supabase data]
- Baseline probability: [Calculate: incidents per worker-hours for this specific task]
- Site exposure today: [Number workers] × [Expected hours] = [exposure units]
- Expected incidents this project: [Calculated probability × project duration]
- Current conditions modifier: [How today's conditions differ from baseline - specific factors]
- Confidence in prediction: [HIGH/MEDIUM/LOW - see criteria below]

IF OSHA data unavailable for exact work type, use closest analog and state:
"Using [analog work type] data - actual risk may vary by [estimated %]"

**Causal Chain - How This Happens:**

1. **Initiating Event:** [What starts the sequence - be specific]
   Evidence from checklist: [Quote specific checklist data showing this is present]

2. **First Defense Failure:** [Which control should prevent this but isn't working]
   Why it's failing: [Root cause - procedure unclear? Equipment unavailable? Time pressure?]
   Evidence from checklist: [What indicates this defense is compromised]

3. **Human Performance Factor:** [What decision/action accelerates the failure]
   Why the worker will make this choice: [Fatigue? Normalized deviation? Production pressure?]
   Observable indicator: [What supervisors would see if watching closely]

4. **Point of No Return:** [The moment when the incident becomes inevitable]
   What changes: [Environmental/equipment/position change that commits to the sequence]
   Time available to intervene: [Estimated seconds/minutes]

5. **Injury Mechanism:** [Exactly how the injury occurs - forces, distances, impact points]
   Expected severity: [Minor/Serious/Critical/Fatal]
   Expected body parts: [Based on OSHA injury distribution for this incident type]

**Leading Indicators Observable RIGHT NOW:**
- [Specific thing supervisors would see if they looked]
- [Specific behavior that signals elevated risk]
- [Specific equipment condition that predicts failure]

**The Near-Miss Version:**
[Describe the non-injury close call - this might have already happened today]
Why it wasn't reported: [Cultural/procedural barrier to near-miss reporting]

**Single Most Effective Intervention:**
[One specific action that breaks the causal chain at the weakest point]
Implementation: [How to actually do this - not just "provide training"]
Verification: [How to confirm it's working - measurable indicator]

---

**INCIDENT FORECAST #2:** [If warranted - distinct mechanism]
[Same detailed structure as #1 - only include if there's a DIFFERENT causal chain]

---

═══════════════════════════════════════════
PREDICTION CONFIDENCE ASSESSMENT
═══════════════════════════════════════════
For each incident forecast provided above, evaluate confidence:

**INCIDENT #1 CONFIDENCE: [HIGH/MEDIUM/LOW]**
Reasoning:
- Data completeness: [X/Y required inputs present - list what's missing]
- Statistical support: [Direct OSHA match / Analogous data / Limited stats]
- Observable indicators: [List specific leading indicators currently visible]
- Control verification: [Controls documented and verified / documented only / unknown]

**INCIDENT #2 CONFIDENCE: [HIGH/MEDIUM/LOW]**
[Same structure]

CONFIDENCE DEFINITIONS:
- HIGH = All critical data present + Direct OSHA stats + Multiple observable precursors + Controls verified
- MEDIUM = Analogous OSHA data + Some data gaps + At least one observable precursor + Controls documented
- LOW = Significant data gaps + Limited statistical support + Prediction based on general construction risk

IF CONFIDENCE IS LOW: State what specific data would raise it to MEDIUM or HIGH.

---

**COMPLIANCE GAPS ENABLING THESE INCIDENTS:**

Each compliance gap below is connected to a specific predicted incident and includes the intervention required.

FORMAT: Standard → Violation → Incident Connection → Required Action → Verification

EXAMPLE:
- **OSHA 1926.502(d)(15)** - Fall Protection Rescue
  Violation: No rescue plan documented for swing stage operations
  Enables Incident #1: If fall arrest occurs, suspended worker → positional asphyxia risk within 6 minutes
  Required Action: Designate rescue team with 6-minute response capability
  Verification: Conduct rescue drill before work authorization, document response time

**Immediate Violations:**
- **[OSHA Standard Number]** - [Standard name]
  Specific violation: [Quote the standard requirement, then show how site fails it]
  Connects to Incident #[X]: [How this violation enables the predicted incident]
  Citation probability if OSHA arrives now: [Low/Medium/High/Certain]

**Incomplete Controls:**
- [What's documented but not actually working]
  Evidence: [From checklist - "No response" answers, contradictory data]
  Real-world gap: [What's actually happening vs what procedures say]

**Statistical Risk Comparison:**
Site's current risk profile vs industry baseline:
[Compare observed hazards to OSHA statistical norms - is this site worse/better/average]

---

**IMMEDIATE ACTIONS - BEFORE WORK STARTS:**

**CRITICAL ACTION #1:** [Prevents Incident #1]
- What: [Specific, measurable action]
- Who: [Specific role - not "competent person" but "crane operator" or "foreman"]
- Verify: [Specific observation that confirms it's done]
- If not done: [Consequence - restates the predicted incident]

**CRITICAL ACTION #2:** [Addresses highest compliance gap]
- What: [Specific action]
- Timeline: [Before first lift / immediately / within 1 hour]
- Documentation: [What record to create]

**STOP-WORK TRIGGERS (Measurable):**
- Stop if wind speed exceeds [X] mph sustained ([equipment limit] per [manufacturer/standard])
- Stop if [specific observable condition] occurs
- ANY WORKER can stop work - method: [specific action like "air horn blast" or "radio 'STOP WORK' on channel 3"]

---

**WEATHER IMPACT ON OPERATIONS:**

Current: ${weatherData?.temperature || 'N/A'}°F, ${weatherData?.windSpeed || 'N/A'} mph wind, ${weatherData?.conditions || 'Unknown conditions'}

Critical finding: [Are you within 20% of any equipment operating limit? State the margin.]

**Equipment-specific limits for TODAY'S CONDITIONS:**

IF equipment specifications are in the checklist data:
- Crane [Model]: Manufacturer limit [X] mph vs Current [Y] mph = [Z]% safety margin
- Swing stage: ANSI/IWCA I-14.1 limit [X] mph vs Current [Y] mph = [Z]% margin
- Glass handling: [How current weather affects THIS specific panel size/weight]

IF equipment specifications are MISSING:
- MISSING: Crane model/specifications - cannot determine manufacturer wind limit
  DEFAULT: Apply ASME B30.3 conservative limit of 20 mph for mobile cranes
- MISSING: Swing stage load capacity - cannot verify current load vs rating
  REQUIRED ACTION: Obtain equipment specifications before authorizing work

**Weather safety margin status:**
- GREEN (>30% margin): Weather not a limiting factor
- YELLOW (20-30% margin): Active monitoring required, stop-work trigger defined
- RED (<20% margin): Too close to limits, recommend postpone until conditions improve

Current status: [GREEN/YELLOW/RED]
Forecast next 2 hours: [Improving/Stable/Deteriorating]
Work stoppage trigger: [Specific measurable weather condition]

---

**HUMAN FACTORS ASSESSMENT:**

Time of day impact: [How ${now.toLocaleTimeString()} affects alertness/fatigue]
Production pressure indicators: [Evidence from checklist suggesting schedule pressure]
Communication quality: [Assessment of coordination systems - radios, signals, pre-job briefings]
Normalization of deviance: [What shortcuts have become "the way we do it"]

These factors increase incident probability by [estimated factor] above baseline.

---

**LONG-TERM RECOMMENDATIONS:**

**This Week:**
1. [Engineering control - physical change that doesn't rely on behavior]
2. [Administrative control - procedure/supervision enhancement]

**This Month:**
1. [System-level improvement - training program, equipment upgrade]
2. [Data collection - what metrics to track for future prediction]

**This Project:**
1. [Organizational change - culture, resources, policy]

---

**EMERGENCY RESPONSE CAPABILITY:**

For Incident #1 ([incident name]):
- Current capability: [Adequate/Inadequate]
- Critical gap: [What's missing that would worsen outcome]
- Required: [Specific equipment/training/plan needed]

For Incident #2 ([incident name]):
[Same assessment]

Nearest Level 1 Trauma Center: [Location - X miles - Y minutes]
On-site first aid: [Adequate/Inadequate for severity of predicted incidents]

═══════════════════════════════════════════
ANALYSIS PRINCIPLES
═══════════════════════════════════════════
✓ Use OSHA statistical data to weight predictions - falls are 36.5% of fatalities, weight accordingly
✓ Call out "No response" checklist answers as RED FLAGS - these are data gaps that hide risk
✓ Connect compliance gaps DIRECTLY to predicted incidents - show the causal link
✓ Provide specific measurable triggers, not vague guidance ("if unsafe" → "if wind exceeds 25mph")
✓ Assume workers are competent but subject to human factors (fatigue, pressure, normalization)
✓ Predict incidents that are STATISTICALLY LIKELY, not worst-case scenarios
✓ Every recommendation must be implementable by the site supervisor reading this
✓ For each documented control, assess ACTUAL EFFECTIVENESS using this scale:
  1 = Documented only, no evidence of implementation
  2 = Partially implemented, inconsistent application observed
  3 = Implemented but not verified/inspected
  4 = Implemented with regular verification/spot-checks
  5 = Engineered control, doesn't depend on worker compliance
  Include effectiveness rating in your incident forecasts when assessing defense failures.

✗ DO NOT hedge with "may," "could," "potentially" - make specific predictions
✗ DO NOT assume procedures work just because they're documented
✗ DO NOT provide generic advice that applies to any construction site
✗ DO NOT ignore production pressure - it's always present and affects safety decisions

═══════════════════════════════════════════
FACTUAL CONSTRAINTS - PREVENT HALLUCINATION
═══════════════════════════════════════════
✓ ONLY cite OSHA standards you can reference with specific section numbers
✓ ONLY reference weather data that appears in [CURRENT CONDITIONS] section above
✓ ONLY use statistical data from [REAL OSHA DATA FROM SUPABASE] section above
✓ If manufacturer limits unknown, state "MISSING: [Equipment model] specifications"
✓ If data is missing, state "MISSING: [specific data needed]" - NEVER estimate or assume

CORRECT response when data missing:
"MISSING: Crane manufacturer specifications required. Without model/config data, cannot determine wind limit. RECOMMEND: Use conservative 20mph limit per ASME B30.3 until specs verified."

INCORRECT response:
"Crane wind limit is typically 25mph" ← NEVER make generic assumptions

✓ When citing distances/measurements, verify they appear in the checklist data
✓ When stating compliance requirements, cite the specific standard section
✓ When predicting injury severity, base on OSHA injury distribution data for that incident type

Your analysis could prevent an injury TODAY. Write accordingly.
═══════════════════════════════════════════

Analyze the checklist above using this framework.`;

    return prompt;
  }

  /**
   * Legacy method for backward compatibility - converts old calls to new format
   * @deprecated Use analyzeChecklistWithWeather with separate weather parameter
   */
  async analyzeChecklistLegacy(checklistData: any): Promise<string> {
    console.warn('Warning: Using legacy analysis method without separate weather data');
    
    // Extract weather if embedded in checklist
    const weatherData = checklistData.weather || null;
    
    return this.analyzeChecklistWithWeather(checklistData, weatherData);
  }
}

export const geminiWithWeatherService = new GeminiWithWeatherService();

KEY CHANGES:

Line 24: weatherData: any now REQUIRED as separate parameter
Line 48: Accepts weather as separate parameter in buildChecklistAnalysisPrompt
Lines 58-71: Weather formatting separated from checklist
Line 104: Weather injected directly: ${weatherSection} - NO MORE CHECKING checklistData.weather
Lines 374-382: Legacy method for backward compatibility if needed


NOW UPDATE YOUR ROUTE:
typescript// In your route file (e.g., analysis.routes.ts)
router.post('/analyze-jha', async (req, res) => {
  try {
    const { checklistData, location } = req.body;
    
    // Fetch weather separately
    const weatherData = await getWeatherForSafetyAnalysis(location);
    
    // Call with BOTH parameters
    const analysis = await geminiWithWeatherService.analyzeChecklistWithWeather(
      checklistData,
      weatherData  // ← Pass separately, don't embed
    );
    
    res.json({ analysis });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
This is 100% Google Gemini, no Anthropic. Replace your file and test.RetryClaude can make mistakes. Please double-check responses. Sonnet 4.5